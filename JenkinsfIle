pipeline {
  agent {
    label 'ETQA-MAC2'
  }

   parameters {
      choice(name:'environment',choices:['QA','STG','LIVE'],description:'')
   }

  stages {
    stage('build and test') {

      steps {
        sh 'npm --version'
        case_tag = "${params.environment}".toLowerCase()
        sh 'echo ${case_tag}'
        if (case_tag == 'qa') {
                      case_tag = 'qa'
         } else if (case_tag == 'live'){
                       case_tag = 'live'
         }
        script {
          sh 'echo ${case_tag}'
          case_tag = "${params.environment}".toLowerCase()
          sh 'echo ${case_tag}'
          sh 'yarn install --frozen-lockfile'
          sh 'yarn cypress:run --browser chrome --env testEnv=${case_tag}  --spec "cypress/integration/e2e/*" --reporter-options configFile=reporter-config.json'
         }
      }
    }
  }
 post {
    always {
      junit 'results/result*.xml'
    }
    failure {
        emailext (
            subject: "FAILED: Job",
            body: "testing"
            to: "curry.sun@ef.com,nancy.zhangcr@ef.com",
            from: "qa.testauto@ef.com"
        )
    }
  }
}